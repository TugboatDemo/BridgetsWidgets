variables:
  # Keeping this low helps jobs find an available runner without waiting.
  # @see https://git.drupalcode.org/project/gitlab_templates/-/blob/main/includes/include.drupalci.main.yml?ref_type=heads
  KUBERNETES_CPU_REQUEST: 2
  # For faster performance, don't audit dependencies automatically.
  COMPOSER_NO_AUDIT: 1
  COMPOSER_NO_INTERACTION: 1

# Define when this pipeline runs.
workflow:
  rules:
    # Run on merge requests.
    - if: $CI_MERGE_REQUEST_IID || $CI_PIPELINE_SOURCE == 'merge_request_event'
    # Run on a regular schedule (i.e., nightly builds).
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # Run when manually triggered via the web UI.
    - if: $CI_PIPELINE_SOURCE == "web"
    # Run when manually triggered via the Web IDE.
    - if: $CI_PIPELINE_SOURCE == "webide"
    # Run when we push to a release branch (not in a fork).
    - if: $CI_COMMIT_BRANCH =~ /^([0-9]+\.)?[0-9]+\.x$/ && $CI_PIPELINE_SOURCE == "push" && $CI_PROJECT_ROOT_NAMESPACE == "project"
    # Run when we push a tag.
    - if: $CI_COMMIT_TAG

default:
  # New pushes can stop the current job and start a new one.
  interruptible: true
  image:
    # This image has a version of SQLite that is compatible with Drupal 11.
    name: 'drupalci/php-8.3-ubuntu-apache:production'

build project:
  stage: build
  script:
    # @todo Don't hard-code the branch name.
    - composer config version 1.x-dev
    - composer archive --file=byte
    - mkdir artifacts
    - mv byte.tar artifacts
    - composer create-project drupal/cms:^2 --stability=rc --no-install
    # Drupal CMS 2 is in development, so allow pre-release versions of all dependencies.
    - composer config minimum-stability rc --working-dir=cms
    # Enable plugins, as required by drupal/core-dev.
    - composer config allow-plugins true --working-dir=cms
    - composer require --no-update --dev drupal/core-dev:^11 --working-dir=cms
    # Configure Composer to install Byte from the archive we just created.
    - composer repository add byte artifact $CI_PROJECT_DIR/artifacts --working-dir=cms
    # Temporarily require Byte Themes's dev branch.
    # Temporarily require the 2.x-dev HEAD of drupal_cms_search.
    # @todo Remove this line when Drupal CMS 2 is stable.
    - composer require --no-update drupal/byte:1.x-dev@dev drupal/byte_theme:1.x-dev@dev drupal/drupal_cms_search:2.x-dev@dev --working-dir=cms
    # Build the code base.
    - composer install --working-dir=cms
  artifacts:
    paths:
      - cms
    expire_in: 1 hour

run tests:
  stage: test
  needs:
    - build project
  services:
    - name: 'drupalci/mysql-8'
      alias: database
    - name: selenium/standalone-chrome:latest
      alias: selenium
      variables:
        JAVA_OPTS: '-Dwebdriver.chrome.logfile=/builds/chromedriver.log'
        SE_NODE_OVERRIDE_MAX_SESSIONS: 'true'
        SE_NODE_MAX_SESSIONS: '16'
        # Give each Selenium node a long timeout (10 minutes); site templates can take
        # a while to apply because they're naturally hefty.
        SE_NODE_SESSION_TIMEOUT: 600
        SE_SESSION_RETRY_INTERVAL: '1'
        SE_SESSION_REQUEST_TIMEOUT: '10'
        SE_START_XVFB: 'false'
        SE_START_VNC: 'false'
  variables:
    MINK_DRIVER_ARGS_WEBDRIVER: '["chrome", {"browserName":"chrome", "goog:chromeOptions":{"w3c": true, "args":["--no-sandbox","--ignore-certificate-errors", "--allow-insecure-localhost", "--headless", "--dns-prefetch-disable"]}}, "http://selenium:4444"]'
    # OPEN_TELEMETRY_COLLECTOR is defined in the project's CI settings so that we
    # can send performance data to Tag1 Consulting.
    # @see https://www.drupal.org/i/3564128
    OTEL_COLLECTOR: '$OPEN_TELEMETRY_COLLECTOR'
    SIMPLETEST_BASE_URL: http://localhost/web
    SIMPLETEST_DB: mysql://drupaltestbot:drupaltestbotpw@database/mysql
  before_script:
    - cd ./cms/web
    # Set up Apache to point to the project's document root.
    - ln -s -f $PWD /var/www/html/web
    - chown -R www-data:www-data $PWD
    - service apache2 start
  script:
    - sudo --preserve-env -u www-data ../vendor/bin/phpunit --display-skipped --log-junit $CI_PROJECT_DIR/junit.xml --configuration=core $CI_PROJECT_DIR/tests
  artifacts:
    paths:
      - ./cms/web/sites/simpletest
    when: on_failure
    expire_in: 3 days
    reports:
      junit: junit.xml
